#!/bin/sh
if [ $# -gt 0 ]
then
    echo "Usage : crefunc_exploit_audit.sh"
    exit 1;
fi


# Variables définissant le serveur d'archive et la base contenant les enregistrements d'audit
LOGIN=XXXX
PASSWORD=yyy
DATASERVER=ZZZZZZ
REPOSITORY=BBBBB





audit__create_functions () 
{

isql -U${LOGIN} -P${PASSWORD}  -S${DATASERVER} -w2222 -Jiso_1 <<EOF
use ${REPOSITORY}
GO
drop  function getIPaddress 
GO
create function getIPaddress 
(@msg varchar(255) )
returns varchar(15)

as

begin

declare @r varchar(15)

declare @debut1 int
declare @debut2 int
declare @debut3 int

declare @taille1 int
declare @taille2 int
declare @taille3 int

declare @chaine1 varchar(255)
declare @chaine2 varchar(255)
declare @chaine3 varchar(255)


select @r="" 

if patindex ( "LOGIN%", @msg ) >0
begin
select @debut1=patindex ( "%|%", @msg)+1
select @taille1=patindex ( "%|%", substring ( @msg, @debut1, 255))
select @chaine1=substring ( @msg, @debut1, @taille1-1) 

select @debut2=@debut1+@taille1
select @taille2=patindex ( "%|%", substring ( @msg, @debut2, 255))
select @chaine2=substring ( @msg, @debut2, @taille2-1) 

select @debut3=@debut2+@taille2
--select @taille3=patindex ( "%|%", substring ( @msg, @debut3, 255))
select @taille3=255
select @chaine3=substring ( @msg, @debut3, @taille3-1) 
select @r=@chaine1
end



return @r
end
GO



drop  function getMachine 
GO
create function getMachine 
(@msg varchar(255) )
returns varchar(30)

as

begin

declare @r varchar(30)

declare @debut1 int
declare @debut2 int
declare @debut3 int

declare @taille1 int
declare @taille2 int
declare @taille3 int

declare @chaine1 varchar(255)
declare @chaine2 varchar(255)
declare @chaine3 varchar(255)


select @r="" 

if patindex ( "LOGIN%", @msg ) >0
begin
select @debut1=patindex ( "%|%", @msg)+1
select @taille1=patindex ( "%|%", substring ( @msg, @debut1, 255))
select @chaine1=substring ( @msg, @debut1, @taille1-1) 

select @debut2=@debut1+@taille1
select @taille2=patindex ( "%|%", substring ( @msg, @debut2, 255))
select @chaine2=substring ( @msg, @debut2, @taille2-1) 

select @debut3=@debut2+@taille2
--select @taille3=patindex ( "%|%", substring ( @msg, @debut3, 255))
select @taille3=255
select @chaine3=substring ( @msg, @debut3, @taille3-1) 


select @r=@chaine2
end

return @r
end
GO

drop  function getApplication 
GO
create function getApplication 
(@msg varchar(255) )
returns varchar(30)

as

begin

declare @r varchar(30)

declare @debut1 int
declare @debut2 int
declare @debut3 int

declare @taille1 int
declare @taille2 int
declare @taille3 int

declare @chaine1 varchar(255)
declare @chaine2 varchar(255)
declare @chaine3 varchar(255)

select @r="" 

if patindex ( "LOGIN%", @msg ) >0
begin
select @debut1=patindex ( "%|%", @msg)+1
select @taille1=patindex ( "%|%", substring ( @msg, @debut1, 255))
select @chaine1=substring ( @msg, @debut1, @taille1-1) 

select @debut2=@debut1+@taille1
select @taille2=patindex ( "%|%", substring ( @msg, @debut2, 255))
select @chaine2=substring ( @msg, @debut2, @taille2-1) 

select @debut3=@debut2+@taille2
--select @taille3=patindex ( "%|%", substring ( @msg, @debut3, 255))
select @taille3=255
select @chaine3=substring ( @msg, @debut3, @taille3-1) 

select @r=@chaine3
end

return @r
end
GO


EOF
}

#
#
#	Main function
#
#


audit__create_functions



